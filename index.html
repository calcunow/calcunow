<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Calc - Financial Utility Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for professional feel and print readiness */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e0e7ee 100%); /* Subtle gradient background */
        }
        .report-section {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .tab-button.active {
            border-color: #4f46e5;
            background-color: #4f46e5;
            color: white;
        }
        /* Style for print output */
        @media print {
            body {
                background: none;
            }
            .no-print {
                display: none;
            }
            #main-content {
                max-width: 100%;
                margin: 0;
                padding: 0;
            }
            .report-section {
                border: none;
                box-shadow: none;
            }
            /* Ensure tables and text are clearly visible in print */
            * {
                color: #000 !important;
                background: #fff !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="auth-screen" class="fixed inset-0 flex items-center justify-center bg-gray-500 bg-opacity-75 z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="auth-title" class="text-3xl font-bold text-gray-800 mb-6 text-center">Login to Wealth Calc</h2>
            <form id="auth-form" class="space-y-4">
                <input type="hidden" id="auth-mode" value="login">
                
                <div id="signup-fields" class="space-y-4 hidden">
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700">Email ID</label>
                        <input type="email" id="signup-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="signup-mobile" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                        <input type="tel" id="signup-mobile" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                </div>

                <div id="login-fields" class="space-y-4">
                    <div>
                        <label for="login-credential" class="block text-sm font-medium text-gray-700">Mobile/Email</label>
                        <input type="text" id="login-credential" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                </div>
                
                <div class="flex justify-between items-center text-sm">
                    <button type="button" id="toggle-auth" class="text-indigo-600 hover:text-indigo-800 transition duration-150 ease-in-out">
                        New User? Sign Up
                    </button>
                    <button type="button" id="forgot-password-btn" class="text-gray-600 hover:text-gray-800 transition duration-150 ease-in-out">
                        Forgot Password?
                    </button>
                </div>

                <button type="submit" id="auth-submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Login
                </button>
            </form>
            <p id="auth-message" class="mt-4 text-center text-sm font-medium text-red-600"></p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header class="no-print bg-white shadow-md">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-3xl font-extrabold text-indigo-700">Wealth Calc</h1>
                <div class="flex items-center space-x-4">
                    <p id="user-info" class="text-gray-600 text-sm hidden sm:block"></p>
                    <button id="logout-btn" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150 ease-in-out">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <main id="main-content" class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="no-print border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button data-tab="broken-period" class="tab-button active py-2 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150 ease-in-out rounded-t-md">
                        üí∞ Broken-Period Interest
                    </button>
                    <button data-tab="cash-flow" class="tab-button py-2 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150 ease-in-out rounded-t-md">
                        üìà Cash Flow Statement
                    </button>
                    <button data-tab="credit-cam" class="tab-button py-2 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150 ease-in-out rounded-t-md">
                        üõ°Ô∏è Credit CAM Verification
                    </button>
                    <button data-tab="admin-area" class="tab-button py-2 px-4 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150 ease-in-out rounded-t-md">
                        üóÉÔ∏è Saved Reports
                    </button>
                </nav>
            </div>

            <div id="broken-period" class="tab-content">
                <div class="report-section">
                    <h2 class="text-xl font-bold mb-4 text-indigo-600">Broken-Period Interest Calculator</h2>
                    <form id="broken-period-form" class="space-y-4">
                        <div id="broken-period-rows" class="space-y-4">
                            <div class="flex space-x-4 items-end">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700">Principal Amount (‚Çπ)</label>
                                    <input type="number" step="0.01" min="0" name="principal" required class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div class="w-1/4">
                                    <label class="block text-sm font-medium text-gray-700">Annual Rate (%)</label>
                                    <input type="number" step="0.01" min="0" name="rate" required class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div class="w-1/4">
                                    <label class="block text-sm font-medium text-gray-700">Days</label>
                                    <input type="number" min="1" name="days" required class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <button type="button" class="remove-broken-row text-red-500 hover:text-red-700 text-2xl pb-1" title="Remove Row">
                                    &times;
                                </button>
                            </div>
                        </div>
                        <button type="button" id="add-broken-row" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">+ Add Another Period</button>
                        
                        <div class="flex justify-start space-x-4 pt-4">
                            <button type="submit" class="no-print bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">
                                Calculate Interest
                            </button>
                        </div>
                    </form>

                    <div id="broken-period-output" class="mt-6 border-t pt-4 hidden">
                        <h3 class="text-lg font-semibold mb-3">Calculation Results</h3>
                        <div id="broken-period-detail" class="text-sm space-y-2"></div>
                        <p class="text-2xl font-bold mt-4 text-indigo-700">Total Broken Interest: <span id="total-broken-interest">‚Çπ0.00</span></p>
                        <p class="text-xs text-gray-500 mt-1">Calculation Timestamp: <span id="broken-timestamp">N/A</span></p>
                        
                        <div class="no-print flex space-x-3 mt-4">
                            <button onclick="saveReport('broken-period')" class="save-report-btn bg-gray-500 hover:bg-gray-600 text-white text-sm py-1 px-3 rounded">Save</button>
                            <button onclick="exportReport('broken-period', 'pdf')" class="export-pdf-btn bg-red-600 hover:bg-red-700 text-white text-sm py-1 px-3 rounded">Export PDF</button>
                            <button onclick="exportReport('broken-period', 'excel')" class="export-excel-btn bg-green-600 hover:bg-green-700 text-white text-sm py-1 px-3 rounded">Export Excel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="cash-flow" class="tab-content hidden">
                <div class="report-section">
                    <h2 class="text-xl font-bold mb-4 text-indigo-600">Cash Flow Statement Tool</h2>
                    
                    <div class="no-print flex space-x-4 mb-4">
                        <button id="mode-sales" class="cash-flow-mode-btn active bg-indigo-500 text-white py-2 px-4 rounded transition">Sales/Agriculture Basis</button>
                        <button id="mode-income" class="cash-flow-mode-btn bg-gray-200 text-gray-800 py-2 px-4 rounded transition">Income/Wage Basis</button>
                    </div>

                    <form id="cash-flow-form" class="space-y-4">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <h4 class="font-semibold text-sm mb-2">Period Selection</h4>
                            <div class="flex space-x-4">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700">Start Date</label>
                                    <input type="date" id="cf-start-date" required class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700">End Date</label>
                                    <input type="date" id="cf-end-date" required class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div class="w-1/4">
                                    <label class="block text-sm font-medium text-gray-700">Working Days (Override)</label>
                                    <input type="number" id="cf-working-days" min="1" class="mt-1 block w-full p-2 border rounded-md" placeholder="Auto-calc or Manual">
                                </div>
                            </div>
                        </div>

                        <div id="cf-sales-fields" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Sales/Income Per Day (‚Çπ)</label>
                                    <input type="number" step="0.01" min="0" id="cf-sales-per-day" class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Margin (%)</label>
                                    <input type="number" step="0.01" min="0" id="cf-margin-percent" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 20">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Direct Expenses (Per Period/Total)</label>
                                <input type="number" step="0.01" min="0" id="cf-direct-expenses" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Electricity (Total)</label>
                                    <input type="number" step="0.01" min="0" id="cf-electricity" class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Rent (Total)</label>
                                    <input type="number" step="0.01" min="0" id="cf-rent" class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Indirect Expenses (Total)</label>
                                    <input type="number" step="0.01" min="0" id="cf-indirect-expenses" class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                            </div>
                        </div>

                        <div id="cf-income-fields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Salary/Wages Per Day (‚Çπ)</label>
                                <input type="number" step="0.01" min="0" id="cf-wage-per-day" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Household Expenses (Total for Period)</label>
                                <input type="number" step="0.01" min="0" id="cf-household-expenses" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Other Expenses (Total for Period)</label>
                                <input type="number" step="0.01" min="0" id="cf-other-expenses" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Existing Loan EMI (Total for Period)</label>
                                <input type="number" step="0.01" min="0" id="cf-existing-emi" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Proposed Loan EMI (Total for Period)</label>
                                <input type="number" step="0.01" min="0" id="cf-proposed-emi" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                        </div>

                        <div class="flex justify-start space-x-4 pt-4">
                            <button type="submit" class="no-print bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">
                                Generate Statement
                            </button>
                        </div>
                    </form>

                    <div id="cash-flow-output" class="mt-6 border-t pt-4 hidden">
                        <h3 class="text-lg font-semibold mb-3">Statement Summary (<span id="cf-mode-display">Sales Basis</span>)</h3>
                        <table class="min-w-full divide-y divide-gray-200">
                            <tbody id="cash-flow-summary-body" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                        <p class="text-xs text-gray-500 mt-3">Calculation Timestamp: <span id="cf-timestamp">N/A</span></p>

                        <div class="no-print flex space-x-3 mt-4">
                            <button onclick="saveReport('cash-flow')" class="save-report-btn bg-gray-500 hover:bg-gray-600 text-white text-sm py-1 px-3 rounded">Save</button>
                            <button onclick="exportReport('cash-flow', 'pdf')" class="export-pdf-btn bg-red-600 hover:bg-red-700 text-white text-sm py-1 px-3 rounded">Export PDF</button>
                            <button onclick="exportReport('cash-flow', 'excel')" class="export-excel-btn bg-green-600 hover:bg-green-700 text-white text-sm py-1 px-3 rounded">Export Excel</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="credit-cam" class="tab-content hidden">
                <div class="report-section">
                    <h2 class="text-xl font-bold mb-4 text-indigo-600">Credit CAM Verification Module</h2>
                    <form id="credit-cam-form" class="space-y-6">
                        
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h3 class="font-bold text-gray-800 mb-3">General & CIBIL</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Verification Type(s)</label>
                                    <select multiple id="cam-verification-types" class="mt-1 block w-full p-2 border rounded-md h-24">
                                        <option>Residence Verification</option>
                                        <option>Asset Verification</option>
                                        <option>Income Verification</option>
                                        <option>Guarantor Verification</option>
                                        <option>Business/Site Visit</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">CIBIL Score</label>
                                    <input type="number" min="300" max="900" id="cam-cibil-score" class="mt-1 block w-full p-2 border rounded-md">
                                    <label class="block text-sm font-medium text-gray-700 mt-2">CIBIL Flags (Negative)</label>
                                    <select multiple id="cam-cibil-flags" class="mt-1 block w-full p-2 border rounded-md h-12">
                                        <option>Default on Loan</option>
                                        <option>Multiple Hard Inquiries</option>
                                        <option>High Credit Utilization</option>
                                        <option>Write-Off/Settled</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 border rounded-lg">
                            <h3 class="font-bold text-gray-800 mb-3">Asset Verification</h3>
                            <div id="cam-asset-rows" class="space-y-3">
                                <div class="flex space-x-3 items-end">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700">Asset Name</label>
                                        <input type="text" name="asset_name" class="mt-1 block w-full p-2 border rounded-md">
                                    </div>
                                    <div class="w-1/4">
                                        <label class="block text-sm font-medium text-gray-700">Status</label>
                                        <select name="asset_status" class="mt-1 block w-full p-2 border rounded-md">
                                            <option>Verified</option>
                                            <option>Not Found</option>
                                            <option>Discrepancy</option>
                                        </select>
                                    </div>
                                    <button type="button" class="remove-asset-row text-red-500 hover:text-red-700 text-2xl pb-1">&times;</button>
                                </div>
                            </div>
                            <button type="button" id="add-asset-row" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium mt-3">+ Add Asset</button>
                        </div>

                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h3 class="font-bold text-gray-800 mb-3">Income Verification</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Source</label>
                                    <select id="cam-income-source" class="mt-1 block w-full p-2 border rounded-md">
                                        <option>Salary</option>
                                        <option>Business/Self-Employed</option>
                                        <option>Agriculture</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Monthly Value (‚Çπ)</label>
                                    <input type="number" step="0.01" min="0" id="cam-income-value" class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div class="col-span-3">
                                    <label class="block text-sm font-medium text-gray-700">Remarks on Income</label>
                                    <textarea id="cam-income-remarks" rows="2" class="mt-1 block w-full p-2 border rounded-md"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 border rounded-lg">
                            <h3 class="font-bold text-gray-800 mb-3">Guarantor Verification</h3>
                            <div id="cam-guarantor-fields" class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="cam-g-name" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Relation</label><input type="text" id="cam-g-relation" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Address</label><input type="text" id="cam-g-address" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Contact</label><input type="tel" id="cam-g-contact" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium text-gray-700">CIBIL Score</label><input type="number" min="300" max="900" id="cam-g-cibil" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Markers (Positive/Negative)</label><select id="cam-g-markers" class="mt-1 block w-full p-2 border rounded-md"><option>-- Select --</option><option>Strong Financial Standing</option><option>Unreliable/Risky</option></select></div>
                            </div>
                        </div>

                        <div class="flex justify-start space-x-4 pt-4">
                            <button type="submit" class="no-print bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">
                                Finalize Verification Report
                            </button>
                        </div>
                    </form>
                    
                    <div id="credit-cam-output" class="mt-6 border-t pt-4 hidden">
                        <p class="text-sm font-semibold text-green-600">Verification Report successfully captured.</p>
                        <p class="text-xs text-gray-500 mt-1">Report Timestamp: <span id="cam-timestamp">N/A</span></p>

                        <div class="no-print flex space-x-3 mt-4">
                            <button onclick="saveReport('credit-cam')" class="save-report-btn bg-gray-500 hover:bg-gray-600 text-white text-sm py-1 px-3 rounded">Save</button>
                            <button onclick="exportReport('credit-cam', 'pdf')" class="export-pdf-btn bg-red-600 hover:bg-red-700 text-white text-sm py-1 px-3 rounded">Export PDF</button>
                            <button onclick="exportReport('credit-cam', 'excel')" class="export-excel-btn bg-green-600 hover:bg-green-700 text-white text-sm py-1 px-3 rounded">Export Excel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="admin-area" class="tab-content hidden">
                <div class="report-section no-print">
                    <h2 class="text-xl font-bold mb-4 text-indigo-600">Saved Reports / Admin Area</h2>
                    
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Filter by Type</label>
                            <select id="report-filter-type" class="mt-1 block w-full p-2 border rounded-md">
                                <option value="">All Types</option>
                                <option value="broken-period">Broken-Period Interest</option>
                                <option value="cash-flow-sales">Cash Flow (Sales)</option>
                                <option value="cash-flow-income">Cash Flow (Income)</option>
                                <option value="credit-cam">Credit CAM</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Filter by Month</label>
                            <input type="number" id="report-filter-month" min="1" max="12" class="mt-1 block w-full p-2 border rounded-md" placeholder="Month (1-12)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Filter by Year</label>
                            <input type="number" id="report-filter-year" min="2000" max="2099" class="mt-1 block w-full p-2 border rounded-md" placeholder="Year (e.g., 2025)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Search</label>
                            <input type="text" id="report-search" class="mt-1 block w-full p-2 border rounded-md" placeholder="Search report content">
                        </div>
                    </div>
                    
                    <button onclick="loadSavedReports()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm py-2 px-4 rounded transition mb-4">
                        Refresh/Apply Filters
                    </button>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Summary</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="saved-reports-table-body" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No reports found.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    // --- Global Variables and Setup ---
let currentUser = null;
const REPORTS_STORAGE_KEY = 'wealthCalcReports';
const USERS_STORAGE_KEY = 'wealthCalcUsers';

// Helper for currency formatting
const formatCurrency = (amount) => {
    return `‚Çπ${Number(amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
};

// Helper for ISO timestamp and readable string
const getTimestamp = () => {
    const now = new Date();
    return {
        iso: now.toISOString(),
        readable: now.toLocaleString()
    };
};

// --- AUTHENTICATION FUNCTIONS ---

const getUsers = () => JSON.parse(localStorage.getItem(USERS_STORAGE_KEY) || '[]');
const saveUsers = (users) => localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
const setSession = (user) => {
    currentUser = user;
    localStorage.setItem('wealthCalcSession', JSON.stringify(user));
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app-container').classList.remove('hidden');
    document.getElementById('user-info').textContent = `Logged in as: ${currentUser.email}`;
    // Initialize the default tool view
    showTab('broken-period'); 
};

const clearSession = () => {
    currentUser = null;
    localStorage.removeItem('wealthCalcSession');
    document.getElementById('auth-screen').classList.remove('hidden');
    document.getElementById('app-container').classList.add('hidden');
    document.getElementById('auth-mode').value = 'login';
    document.getElementById('auth-title').textContent = 'Login to Wealth Calc';
    document.getElementById('toggle-auth').textContent = 'New User? Sign Up';
    document.getElementById('signup-fields').classList.add('hidden');
    document.getElementById('login-fields').classList.remove('hidden');
};

const handleAuth = (event) => {
    event.preventDefault();
    const mode = document.getElementById('auth-mode').value;
    const authMessage = document.getElementById('auth-message');
    authMessage.textContent = '';
    
    let users = getUsers();

    if (mode === 'signup') {
        const email = document.getElementById('signup-email').value;
        const mobile = document.getElementById('signup-mobile').value;
        const password = document.getElementById('login-password').value; // Password field is shared

        if (users.find(u => u.email === email || u.mobile === mobile)) {
            authMessage.textContent = 'User with this email or mobile already exists.';
            return;
        }

        const newUser = {
            id: Date.now(),
            email,
            mobile,
            password: password, // In a real app, hash this!
            createdAt: getTimestamp().iso
        };
        users.push(newUser);
        saveUsers(users);
        setSession(newUser);
        authMessage.textContent = 'Signup successful! Logging you in...';

    } else if (mode === 'login') {
        const credential = document.getElementById('login-credential').value;
        const password = document.getElementById('login-password').value;
        
        const user = users.find(u => 
            (u.email === credential || u.mobile === credential) && u.password === password
        );

        if (user) {
            setSession(user);
        } else {
            authMessage.textContent = 'Invalid credentials. Please try again.';
        }
    }
};

const handleForgotPassword = () => {
    const users = getUsers();
    const emailPrompt = prompt("Please enter your registered Email ID to reset your password:");

    if (!emailPrompt) return;

    const user = users.find(u => u.email === emailPrompt);
    const authMessage = document.getElementById('auth-message');
    authMessage.textContent = '';

    // Secure Simulation: Do not reveal if the email exists, and do not email the password.
    // Instead, simulate sending a password reset link.
    alert("Message popup: Please check your mail for the password reset link. (Simulation)");
    
    if (user) {
        const newPassword = prompt("Please enter a new password:");
        if (newPassword && newPassword.length >= 6) {
            user.password = newPassword;
            saveUsers(users);
            authMessage.textContent = 'Your password has been successfully reset. Please log in.';
            document.getElementById('login-password').value = '';
            document.getElementById('login-credential').value = user.email;
        } else if (newPassword) {
            authMessage.textContent = 'Password must be at least 6 characters long.';
        }
    } else {
        // Even if user not found, give a generic message for security
        authMessage.textContent = 'If an account matches, a password reset instruction has been sent.';
    }
};

// --- CORE UTILITY FUNCTIONS ---

// Tab switching
const showTab = (tabId) => {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'text-white'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.add('text-gray-500'));
    
    document.getElementById(tabId).classList.remove('hidden');
    const activeBtn = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active', 'bg-indigo-600', 'text-white');
        activeBtn.classList.remove('text-gray-500', 'hover:text-gray-700');
    }

    if (tabId === 'admin-area') {
        loadSavedReports();
    }
};

// --- DATA STORAGE AND RETRIEVAL ---

const getReports = () => JSON.parse(localStorage.getItem(REPORTS_STORAGE_KEY) || '[]');

const saveReport = (type, data = null) => {
    if (!currentUser) {
        alert("Please log in to save a report.");
        return;
    }

    let reportData = {};
    let outputEl;

    if (type === 'broken-period') {
        reportData = data || JSON.parse(document.getElementById('broken-period-output').dataset.reportData || '{}');
        outputEl = document.getElementById('broken-period-output');
        if (outputEl.classList.contains('hidden')) { alert("Please calculate the interest first."); return; }
    } else if (type.startsWith('cash-flow')) {
        reportData = data || JSON.parse(document.getElementById('cash-flow-output').dataset.reportData || '{}');
        outputEl = document.getElementById('cash-flow-output');
        if (outputEl.classList.contains('hidden')) { alert("Please generate the statement first."); return; }
    } else if (type === 'credit-cam') {
        reportData = data || JSON.parse(document.getElementById('credit-cam-output').dataset.reportData || '{}');
        outputEl = document.getElementById('credit-cam-output');
        if (outputEl.classList.contains('hidden')) { alert("Please finalize the verification report first."); return; }
    } else {
        reportData = data; // Used when loading from admin to re-save
    }
    
    if (Object.keys(reportData).length === 0) return;

    const reports = getReports();
    const now = getTimestamp();

    // Check if the report is being updated (e.g., loaded from admin and modified)
    if (reportData.id) {
        const index = reports.findIndex(r => r.id === reportData.id);
        if (index > -1) {
            reports[index] = { ...reports[index], ...reportData, modifiedAt: now.iso };
        }
    } else {
        // New report
        reports.push({
            id: Date.now(),
            type: reportData.type,
            userId: currentUser.id,
            userEmail: currentUser.email,
            data: reportData,
            createdAt: now.iso,
            modifiedAt: now.iso
        });
    }

    localStorage.setItem(REPORTS_STORAGE_KEY, JSON.stringify(reports));
    alert(`Report (${reportData.type}) saved successfully to Local Storage!`);
    loadSavedReports(); // Refresh admin area if visible
};

// --- BROKEN-PERIOD LOGIC ---

const calculateBrokenPeriod = (event) => {
    event.preventDefault();
    const form = event.target;
    const rows = form.querySelectorAll('#broken-period-rows > div');
    let totalInterest = 0;
    const reportDetails = [];

    rows.forEach((row, index) => {
        const principal = Number(row.querySelector('[name="principal"]').value);
        const rate = Number(row.querySelector('[name="rate"]').value);
        const days = Number(row.querySelector('[name="days"]').value);

        if (principal > 0 && rate > 0 && days > 0) {
            // Simple Interest: P * R * T / 100 where T is days/365
            const interest = (principal * rate * days) / 36500;
            const roundedInterest = Math.round(interest * 100) / 100;
            totalInterest += roundedInterest;

            reportDetails.push({
                principal: principal,
                rate: rate,
                days: days,
                calculatedInterest: roundedInterest,
                formula: `${principal} * ${rate}% * ${days}/365`
            });
        }
    });

    const timestamp = getTimestamp();
    
    document.getElementById('total-broken-interest').textContent = formatCurrency(totalInterest);
    document.getElementById('broken-timestamp').textContent = timestamp.readable;
    document.getElementById('broken-period-output').classList.remove('hidden');

    const detailHtml = reportDetails.map(d => 
        `<p class="ml-4">- **Principal ${formatCurrency(d.principal)}** @ ${d.rate}% for ${d.days} days: ${formatCurrency(d.calculatedInterest)}</p>`
    ).join('');
    document.getElementById('broken-period-detail').innerHTML = `**Total Periods Calculated:** ${reportDetails.length}<br>` + detailHtml;

    // Store data for export/save
    document.getElementById('broken-period-output').dataset.reportData = JSON.stringify({
        type: 'broken-period',
        totalInterest: totalInterest,
        details: reportDetails,
        timestamp: timestamp.iso
    });
};

const addBrokenRow = () => {
    const container = document.getElementById('broken-period-rows');
    const newRow = document.createElement('div');
    newRow.className = 'flex space-x-4 items-end';
    newRow.innerHTML = `
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700">Principal Amount (‚Çπ)</label>
            <input type="number" step="0.01" min="0" name="principal" required class="mt-1 block w-full p-2 border rounded-md">
        </div>
        <div class="w-1/4">
            <label class="block text-sm font-medium text-gray-700">Annual Rate (%)</label>
            <input type="number" step="0.01" min="0" name="rate" required class="mt-1 block w-full p-2 border rounded-md">
        </div>
        <div class="w-1/4">
            <label class="block text-sm font-medium text-gray-700">Days</label>
            <input type="number" min="1" name="days" required class="mt-1 block w-full p-2 border rounded-md">
        </div>
        <button type="button" class="remove-broken-row text-red-500 hover:text-red-700 text-2xl pb-1" title="Remove Row">
            &times;
        </button>
    `;
    newRow.querySelector('.remove-broken-row').onclick = (e) => e.target.closest('.flex').remove();
    container.appendChild(newRow);
};


// --- CASH FLOW LOGIC ---

let cashFlowMode = 'sales';

const toggleCashFlowMode = (mode) => {
    cashFlowMode = mode;
    document.getElementById('cf-sales-fields').classList.toggle('hidden', mode !== 'sales');
    document.getElementById('cf-income-fields').classList.toggle('hidden', mode !== 'income');
    document.getElementById('cf-mode-display').textContent = mode === 'sales' ? 'Sales Basis' : 'Income/Wage Basis';

    document.querySelectorAll('.cash-flow-mode-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-500', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-800');
    });
    document.getElementById(`mode-${mode}`).classList.add('active', 'bg-indigo-500', 'text-white');
    document.getElementById(`mode-${mode}`).classList.remove('bg-gray-200', 'text-gray-800');
};

const calculateCashFlow = (event) => {
    event.preventDefault();

    const startDate = document.getElementById('cf-start-date').value;
    const endDate = document.getElementById('cf-end-date').value;
    const manualDays = Number(document.getElementById('cf-working-days').value) || 0;
    
    if (!startDate || !endDate) { alert("Please select a Start and End Date."); return; }

    const start = new Date(startDate);
    const end = new Date(endDate);
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1; // Inclusive

    let workingDays = manualDays;
    if (workingDays === 0) {
        workingDays = 0;
        let currentDate = new Date(start);
        while (currentDate <= end) {
            const dayOfWeek = currentDate.getDay();
            if (dayOfWeek !== 0) { // 0 = Sunday (Exclude Sunday)
                workingDays++;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }
    
    let results = {
        type: `cash-flow-${cashFlowMode}`,
        period: `${startDate} to ${endDate}`,
        totalDays: totalDays,
        workingDays: workingDays,
        timestamp: getTimestamp().iso
    };

    let summaryHtml = '';

    if (cashFlowMode === 'sales') {
        // Mode A: Sales/Agriculture Basis
        const salesPerDay = Number(document.getElementById('cf-sales-per-day').value) || 0;
        const marginPercent = Number(document.getElementById('cf-margin-percent').value) || 0;
        const directExpenses = Number(document.getElementById('cf-direct-expenses').value) || 0;
        const electricity = Number(document.getElementById('cf-electricity').value) || 0;
        const rent = Number(document.getElementById('cf-rent').value) || 0;
        const indirectExpenses = Number(document.getElementById('cf-indirect-expenses').value) || 0;

        const totalSales = salesPerDay * workingDays;
        const totalGrossMargin = totalSales * (marginPercent / 100);
        const totalExpenses = directExpenses + electricity + rent + indirectExpenses;
        const netDisposableIncome = totalGrossMargin - totalExpenses;

        results = { 
            ...results, 
            totalSales, 
            totalGrossMargin, 
            totalExpenses, 
            netDisposableIncome,
            inputs: { salesPerDay, marginPercent, directExpenses, electricity, rent, indirectExpenses }
        };

        summaryHtml = `
            <tr><td class="px-6 py-3 font-medium">Total Period Days</td><td class="px-6 py-3 text-right">${totalDays}</td></tr>
            <tr><td class="px-6 py-3 font-medium">Working Days Used</td><td class="px-6 py-3 text-right">${workingDays}</td></tr>
            <tr><td class="px-6 py-3 font-bold">Total Sales/Income</td><td class="px-6 py-3 text-right font-bold">${formatCurrency(totalSales)}</td></tr>
            <tr><td class="px-6 py-3">Gross Margin (${marginPercent}%)</td><td class="px-6 py-3 text-right">${formatCurrency(totalGrossMargin)}</td></tr>
            <tr><td class="px-6 py-3 font-semibold text-red-700">Total Expenses (Direct + Indirect)</td><td class="px-6 py-3 text-right font-semibold text-red-700">${formatCurrency(totalExpenses)}</td></tr>
            <tr><td class="px-6 py-3 font-bold text-indigo-700">Net Disposable Income (NDI)</td><td class="px-6 py-3 text-right font-bold text-indigo-700">${formatCurrency(netDisposableIncome)}</td></tr>
        `;

    } else {
        // Mode B: Income/Wage Basis
        const wagePerDay = Number(document.getElementById('cf-wage-per-day').value) || 0;
        const householdExpenses = Number(document.getElementById('cf-household-expenses').value) || 0;
        const otherExpenses = Number(document.getElementById('cf-other-expenses').value) || 0;
        const existingEmi = Number(document.getElementById('cf-existing-emi').value) || 0;
        const proposedEmi = Number(document.getElementById('cf-proposed-emi').value) || 0;

        const totalIncome = wagePerDay * workingDays;
        const totalLivingExpenses = householdExpenses + otherExpenses;
        const disposableIncomeBeforeEMI = totalIncome - totalLivingExpenses;
        const disposableAfterExistingEMI = disposableIncomeBeforeEMI - existingEmi;
        const finalDisposable = disposableAfterExistingEMI - proposedEmi;

        results = { 
            ...results, 
            totalIncome, 
            disposableIncomeBeforeEMI, 
            disposableAfterExistingEMI, 
            finalDisposable,
            inputs: { wagePerDay, householdExpenses, otherExpenses, existingEmi, proposedEmi }
        };

        summaryHtml = `
            <tr><td class="px-6 py-3 font-medium">Total Period Days</td><td class="px-6 py-3 text-right">${totalDays}</td></tr>
            <tr><td class="px-6 py-3 font-medium">Working Days Used</td><td class="px-6 py-3 text-right">${workingDays}</td></tr>
            <tr><td class="px-6 py-3 font-bold">Total Income Earned</td><td class="px-6 py-3 text-right font-bold">${formatCurrency(totalIncome)}</td></tr>
            <tr><td class="px-6 py-3">(-) Household & Other Expenses</td><td class="px-6 py-3 text-right text-red-700">(${formatCurrency(totalLivingExpenses)})</td></tr>
            <tr><td class="px-6 py-3 font-semibold">Disposable Income (Pre-EMI)</td><td class="px-6 py-3 text-right font-semibold">${formatCurrency(disposableIncomeBeforeEMI)}</td></tr>
            <tr><td class="px-6 py-3">(-) Existing Loan EMI</td><td class="px-6 py-3 text-right text-red-700">(${formatCurrency(existingEmi)})</td></tr>
            <tr><td class="px-6 py-3 font-semibold">Disposable Income (Post-Existing EMI)</td><td class="px-6 py-3 text-right font-semibold">${formatCurrency(disposableAfterExistingEMI)}</td></tr>
            <tr><td class="px-6 py-3">(-) **PROPOSED** Loan EMI</td><td class="px-6 py-3 text-right text-red-700">(${formatCurrency(proposedEmi)})</td></tr>
            <tr><td class="px-6 py-3 font-bold text-indigo-700">Final Disposable Left</td><td class="px-6 py-3 text-right font-bold text-indigo-700">${formatCurrency(finalDisposable)}</td></tr>
        `;
    }

    document.getElementById('cash-flow-summary-body').innerHTML = summaryHtml;
    document.getElementById('cf-timestamp').textContent = getTimestamp().readable;
    document.getElementById('cash-flow-output').classList.remove('hidden');

    // Store data for export/save
    document.getElementById('cash-flow-output').dataset.reportData = JSON.stringify(results);
};

// --- CREDIT CAM LOGIC ---

const handleCreditCamSubmit = (event) => {
    event.preventDefault();
    
    // 1. General & CIBIL
    const selectedVerificationTypes = Array.from(document.getElementById('cam-verification-types').selectedOptions).map(option => option.value);
    const selectedCIBILFlags = Array.from(document.getElementById('cam-cibil-flags').selectedOptions).map(option => option.value);

    // 2. Asset Verification
    const assetRows = document.querySelectorAll('#cam-asset-rows > .flex');
    const assetVerifications = Array.from(assetRows).map(row => ({
        name: row.querySelector('[name="asset_name"]').value,
        status: row.querySelector('[name="asset_status"]').value,
    })).filter(a => a.name);

    // 3. Income Verification
    const incomeVerification = {
        source: document.getElementById('cam-income-source').value,
        value: Number(document.getElementById('cam-income-value').value) || 0,
        remarks: document.getElementById('cam-income-remarks').value
    };

    // 4. Guarantor Verification
    const guarantorVerification = {
        name: document.getElementById('cam-g-name').value,
        relation: document.getElementById('cam-g-relation').value,
        address: document.getElementById('cam-g-address').value,
        contact: document.getElementById('cam-g-contact').value,
        cibil: Number(document.getElementById('cam-g-cibil').value) || 'N/A',
        markers: document.getElementById('cam-g-markers').value
    };

    const reportData = {
        type: 'credit-cam',
        timestamp: getTimestamp().iso,
        verificationTypes: selectedVerificationTypes,
        cibil: {
            score: Number(document.getElementById('cam-cibil-score').value) || 'N/A',
            flags: selectedCIBILFlags
        },
        assets: assetVerifications,
        income: incomeVerification,
        guarantor: guarantorVerification
    };

    document.getElementById('cam-timestamp').textContent = getTimestamp().readable;
    document.getElementById('credit-cam-output').classList.remove('hidden');
    document.getElementById('credit-cam-output').dataset.reportData = JSON.stringify(reportData);

    // Prompt to save immediately
    saveReport('credit-cam', reportData);
};

const addAssetRow = () => {
    const container = document.getElementById('cam-asset-rows');
    const newRow = document.createElement('div');
    newRow.className = 'flex space-x-3 items-end';
    newRow.innerHTML = `
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700">Asset Name</label>
            <input type="text" name="asset_name" class="mt-1 block w-full p-2 border rounded-md">
        </div>
        <div class="w-1/4">
            <label class="block text-sm font-medium text-gray-700">Status</label>
            <select name="asset_status" class="mt-1 block w-full p-2 border rounded-md">
                <option>Verified</option>
                <option>Not Found</option>
                <option>Discrepancy</option>
            </select>
        </div>
        <button type="button" class="remove-asset-row text-red-500 hover:text-red-700 text-2xl pb-1" title="Remove Row">&times;</button>
    `;
    newRow.querySelector('.remove-asset-row').onclick = (e) => e.target.closest('.flex').remove();
    container.appendChild(newRow);
};


// --- ADMIN AREA / REPORT MANAGEMENT LOGIC ---

const loadSavedReports = () => {
    const reports = getReports();
    const tableBody = document.getElementById('saved-reports-table-body');
    tableBody.innerHTML = '';
    
    // Get filters
    const filterType = document.getElementById('report-filter-type').value;
    const filterMonth = Number(document.getElementById('report-filter-month').value);
    const filterYear = Number(document.getElementById('report-filter-year').value);
    const searchTerm = document.getElementById('report-search').value.toLowerCase();

    const filteredReports = reports.filter(report => {
        // 1. Type Filter
        if (filterType && !report.type.startsWith(filterType)) return false;

        // 2. Date Filters
        const date = new Date(report.createdAt);
        if (filterMonth && date.getMonth() + 1 !== filterMonth) return false;
        if (filterYear && date.getFullYear() !== filterYear) return false;

        // 3. Search Term (Simple check on stringified data)
        if (searchTerm && !JSON.stringify(report.data).toLowerCase().includes(searchTerm)) return false;
        
        return true;
    }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort by newest first

    if (filteredReports.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No reports found matching criteria.</td></tr>';
        return;
    }

    filteredReports.forEach(report => {
        let summary = 'N/A';
        const typeDisplay = report.type.replace('-', ' ').toUpperCase();

        if (report.type === 'broken-period') {
            summary = `Interest: ${formatCurrency(report.data.totalInterest)} (${report.data.details.length} periods)`;
        } else if (report.type.startsWith('cash-flow')) {
            summary = `NDI/Disposable: ${formatCurrency(report.data.netDisposableIncome || report.data.finalDisposable)} - Period: ${report.data.period}`;
        } else if (report.type === 'credit-cam') {
            summary = `CIBIL: ${report.data.cibil.score} - ${report.data.verificationTypes.join(', ')}`;
        }

        const row = tableBody.insertRow();
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${typeDisplay}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.userEmail}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(report.createdAt).toLocaleString()}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${summary}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                <button onclick="viewReportDetails(${report.id})" class="text-indigo-600 hover:text-indigo-900">View</button>
                <button onclick="exportSingleReport(${report.id}, 'pdf')" class="text-red-600 hover:text-red-900">PDF</button>
                <button onclick="exportSingleReport(${report.id}, 'excel')" class="text-green-600 hover:text-green-900">Excel</button>
                <button onclick="deleteReport(${report.id})" class="text-red-600 hover:text-red-900">Delete</button>
            </td>
        `;
    });
};

const viewReportDetails = (reportId) => {
    const report = getReports().find(r => r.id === reportId);
    if (!report) return;

    // A simple, readable JSON view
    const detailsWindow = window.open("", "_blank");
    detailsWindow.document.write(`
        <html><head><title>Report ${report.id}</title>
        <style>body { font-family: monospace; white-space: pre-wrap; padding: 20px; }</style>
        </head><body>
        <h2>Wealth Calc Report Details</h2>
        <pre>${JSON.stringify(report, null, 2)}</pre>
        </body></html>
    `);
    detailsWindow.document.close();
};

const deleteReport = (reportId) => {
    if (confirm("Are you sure you want to delete this report? This action is permanent.")) {
        let reports = getReports();
        reports = reports.filter(r => r.id !== reportId);
        localStorage.setItem(REPORTS_STORAGE_KEY, JSON.stringify(reports));
        loadSavedReports();
    }
};

const exportSingleReport = (reportId, format) => {
    const report = getReports().find(r => r.id === reportId);
    if (report) {
        // Temporarily set the data attribute for the general export function
        // This is a workaround as the main export functions rely on the current tab's data
        const tempContainer = document.createElement('div');
        tempContainer.dataset.reportData = JSON.stringify(report.data);
        exportReport(report.data.type, format, tempContainer);
    }
};

// --- EXPORT LOGIC (PDF and Excel) ---

const exportReport = (type, format, sourceElement = null) => {
    let reportData;
    let filename;

    // Use the provided source element for single-report export, or the active tab's output
    if (sourceElement) {
        reportData = JSON.parse(sourceElement.dataset.reportData || '{}');
    } else {
        const outputEl = document.getElementById(`${type}-output`);
        if (outputEl.classList.contains('hidden')) { 
            alert("Please calculate the report first."); 
            return; 
        }
        reportData = JSON.parse(outputEl.dataset.reportData || '{}');
    }
    
    if (Object.keys(reportData).length === 0) {
        alert("No data to export.");
        return;
    }
    
    filename = `WealthCalc_Report_${reportData.type}_${new Date().toISOString().slice(0, 10)}`;

    if (format === 'pdf') {
        exportToPDF(reportData, filename);
    } else if (format === 'excel') {
        exportToExcel(reportData, filename);
    }
};

const exportToPDF = (data, filename) => {
    // This function requires jspdf and jspdf-autotable to be loaded (in Part 1)
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let title = 'Wealth Calc Report';
    let head = [['Field', 'Value']];
    let body = [];

    const date = new Date(data.timestamp || data.createdAt).toLocaleString();
    
    if (data.type === 'broken-period') {
        title = 'Broken-Period Interest Calculation';
        head = [['Principal (‚Çπ)', 'Rate (%)', 'Days', 'Interest (‚Çπ)']];
        body = data.details.map(d => [
            formatCurrency(d.principal), d.rate, d.days, formatCurrency(d.calculatedInterest)
        ]);
        body.push(['', '', 'TOTAL INTEREST:', formatCurrency(data.totalInterest)]);

    } else if (data.type.startsWith('cash-flow')) {
        title = data.type === 'cash-flow-sales' ? 'Cash Flow Statement (Sales/Agri)' : 'Cash Flow Statement (Income/Wage)';
        if (data.type === 'cash-flow-sales') {
            body = [
                ['Period', data.period],
                ['Working Days', data.workingDays],
                ['Total Sales/Income', formatCurrency(data.totalSales)],
                ['Gross Margin', formatCurrency(data.totalGrossMargin)],
                ['Total Expenses', formatCurrency(data.totalExpenses)],
                ['Net Disposable Income', formatCurrency(data.netDisposableIncome)],
            ];
        } else {
            body = [
                ['Period', data.period],
                ['Working Days', data.workingDays],
                ['Total Income Earned', formatCurrency(data.totalIncome)],
                ['Disposable Income (Pre-EMI)', formatCurrency(data.disposableIncomeBeforeEMI)],
                ['Existing Loan EMI', formatCurrency(data.inputs.existingEmi)],
                ['Proposed Loan EMI', formatCurrency(data.inputs.proposedEmi)],
                ['Final Disposable Left', formatCurrency(data.finalDisposable)],
            ];
        }

    } else if (data.type === 'credit-cam') {
        title = 'Credit CAM Verification Report';
        body = [
            ['Verification Types', data.verificationTypes.join(', ')],
            ['CIBIL Score', data.cibil.score],
            ['CIBIL Flags', data.cibil.flags.join(', ') || 'None'],
            ['Income Source', data.income.source],
            ['Income Value (Monthly)', formatCurrency(data.income.value)],
            ['Guarantor Name', data.guarantor.name || 'N/A'],
        ];
        // Add Assets as a separate table
        doc.text(title, 14, 20);
        doc.setFontSize(10);
        doc.text(`Generated: ${date}`, 14, 25);
        
        doc.autoTable({
            startY: 30,
            head: [['Field', 'Value']],
            body: body,
            theme: 'striped',
            headStyles: { fillColor: [79, 70, 229] }
        });

        if (data.assets && data.assets.length > 0) {
            doc.addPage();
            doc.text("Asset Verification Details", 14, 20);
            const assetBody = data.assets.map(a => [a.name, a.status]);
            doc.autoTable({
                startY: 25,
                head: [['Asset Name', 'Verification Status']],
                body: assetBody,
                theme: 'striped'
            });
        }
        
        doc.save(`${filename}.pdf`);
        return;
    }

    doc.text(title, 14, 20);
    doc.setFontSize(10);
    doc.text(`Generated: ${date}`, 14, 25);

    doc.autoTable({
        startY: 30,
        head: head,
        body: body,
        theme: 'striped',
        headStyles: { fillColor: [79, 70, 229] }
    });
    
    doc.save(`${filename}.pdf`);
};

const exportToExcel = (data, filename) => {
    // This function requires xlsx to be loaded (in Part 1)
    const ws_data = [];
    const workbook = XLSX.utils.book_new();

    if (data.type === 'broken-period') {
        ws_data.push(['Wealth Calc - Broken-Period Interest Report']);
        ws_data.push(['Timestamp', new Date(data.timestamp).toLocaleString()]);
        ws_data.push(['']);
        ws_data.push(['Principal (‚Çπ)', 'Rate (%)', 'Days', 'Interest (‚Çπ)']);
        data.details.forEach(d => {
            ws_data.push([d.principal, d.rate, d.days, d.calculatedInterest]);
        });
        ws_data.push(['', '', 'TOTAL INTEREST:', data.totalInterest]);
    } else if (data.type.startsWith('cash-flow')) {
        ws_data.push([data.type === 'cash-flow-sales' ? 'Cash Flow Statement (Sales/Agri)' : 'Cash Flow Statement (Income/Wage)']);
        ws_data.push(['Period', data.period]);
        ws_data.push(['Working Days', data.workingDays]);
        ws_data.push(['']);
        if (data.type === 'cash-flow-sales') {
            ws_data.push(['Metric', 'Amount (‚Çπ)']);
            ws_data.push(['Total Sales/Income', data.totalSales]);
            ws_data.push(['Gross Margin', data.totalGrossMargin]);
            ws_data.push(['Total Expenses', data.totalExpenses]);
            ws_data.push(['Net Disposable Income', data.netDisposableIncome]);
        } else {
            ws_data.push(['Metric', 'Amount (‚Çπ)']);
            ws_data.push(['Total Income Earned', data.totalIncome]);
            ws_data.push(['Disposable Income (Pre-EMI)', data.disposableIncomeBeforeEMI]);
            ws_data.push(['Existing Loan EMI', data.inputs.existingEmi]);
            ws_data.push(['Proposed Loan EMI', data.inputs.proposedEmi]);
            ws_data.push(['Final Disposable Left', data.finalDisposable]);
        }
    } else if (data.type === 'credit-cam') {
        ws_data.push(['Wealth Calc - Credit CAM Report']);
        ws_data.push(['Timestamp', new Date(data.timestamp).toLocaleString()]);
        ws_data.push(['']);
        ws_data.push(['Field', 'Value']);
        ws_data.push(['CIBIL Score', data.cibil.score]);
        ws_data.push(['Verification Types', data.verificationTypes.join(', ')]);
        ws_data.push(['CIBIL Flags', data.cibil.flags.join(', ')]);
        ws_data.push(['Income Source', data.income.source]);
        ws_data.push(['Income Value (Monthly)', data.income.value]);
        ws_data.push(['Guarantor Name', data.guarantor.name]);
        ws_data.push(['']);
        ws_data.push(['Asset Name', 'Verification Status']);
        data.assets.forEach(a => ws_data.push([a.name, a.status]));
    }
    
    const worksheet = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(workbook, worksheet, "Report");
    XLSX.writeFile(workbook, `${filename}.xlsx`);
};

// --- Initialization and Event Listeners ---

document.addEventListener('DOMContentLoaded', () => {
    // Check for existing session
    const session = localStorage.getItem('wealthCalcSession');
    if (session) {
        currentUser = JSON.parse(session);
        setSession(currentUser);
    }

    // AUTH Events
    document.getElementById('auth-form').addEventListener('submit', handleAuth);
    document.getElementById('logout-btn').addEventListener('click', clearSession);
    document.getElementById('forgot-password-btn').addEventListener('click', handleForgotPassword);
    
    document.getElementById('toggle-auth').addEventListener('click', () => {
        const authModeInput = document.getElementById('auth-mode');
        const isLoginMode = authModeInput.value === 'login';
        
        authModeInput.value = isLoginMode ? 'signup' : 'login';
        document.getElementById('auth-title').textContent = isLoginMode ? 'Sign Up for Wealth Calc' : 'Login to Wealth Calc';
        document.getElementById('toggle-auth').textContent = isLoginMode ? 'Already have an account? Login' : 'New User? Sign Up';
        document.getElementById('auth-submit-btn').textContent = isLoginMode ? 'Sign Up' : 'Login';
        
        document.getElementById('signup-fields').classList.toggle('hidden', !isLoginMode);
        document.getElementById('login-fields').classList.toggle('hidden', isLoginMode);
    });

    // Tab Events
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => showTab(btn.dataset.tab));
    });

    // Broken Period Events
    document.getElementById('broken-period-form').addEventListener('submit', calculateBrokenPeriod);
    document.getElementById('add-broken-row').addEventListener('click', addBrokenRow);
    document.querySelectorAll('.remove-broken-row').forEach(btn => 
        btn.addEventListener('click', (e) => e.target.closest('.flex').remove())
    );

    // Cash Flow Events
    document.getElementById('mode-sales').addEventListener('click', () => toggleCashFlowMode('sales'));
    document.getElementById('mode-income').addEventListener('click', () => toggleCashFlowMode('income'));
    document.getElementById('cash-flow-form').addEventListener('submit', calculateCashFlow);

    // Credit CAM Events
    document.getElementById('add-asset-row').addEventListener('click', addAssetRow);
    document.getElementById('credit-cam-form').addEventListener('submit', handleCreditCamSubmit);
    document.querySelectorAll('.remove-asset-row').forEach(btn => 
        btn.addEventListener('click', (e) => e.target.closest('.flex').remove())
    );

    // Admin Filter Events (re-load reports on input/change)
    document.getElementById('report-filter-type').addEventListener('change', loadSavedReports);
    document.getElementById('report-filter-month').addEventListener('input', loadSavedReports);
    document.getElementById('report-filter-year').addEventListener('input', loadSavedReports);
    document.getElementById('report-search').addEventListener('input', loadSavedReports);
});

// Expose functions globally for inline HTML event handlers (e.g., onclick)
window.saveReport = saveReport;
window.exportReport = exportReport;
window.exportSingleReport = exportSingleReport;
window.viewReportDetails = viewReportDetails;
window.deleteReport = deleteReport;
window.loadSavedReports = loadSavedReports;
</script>
</body>
</html>